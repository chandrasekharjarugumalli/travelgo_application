{% extends 'base.html' %}
{% block title %}Select Seats - {{ flight.airline }} {{ flight.number }}{% endblock %}

{% block content %}
<style>
    .seat {
        width: 35px;
        height: 35px;
        border: 1px solid #ccc;
        margin: 4px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 5px;
        cursor: pointer;
        font-size: 11px;
        font-weight: bold;
    }
    .seat.available { background-color: #a0e8a0; }
    .seat.booked { background-color: #f0a0a0; cursor: not-allowed; }
    .seat.selected { background-color: #a0a0f0; }
    .seat-layout {
        display: grid;
        grid-template-columns: repeat(7, auto); /* 3 seats, aisle, 3 seats */
        gap: 5px;
        max-width: 400px;
        justify-content: center;
    }
    .seat-layout .aisle {
        width: 20px; /* Aisle space */
    }
</style>

<div class="container mx-auto p-8">
    <h1 class="text-3xl font-bold">Select Your Seats</h1>
    <div class="mt-4 text-lg">
        <p><strong>Flight:</strong> {{ flight.airline }} {{ flight.number }}</p>
        <p><strong>From:</strong> {{ flight.origin }} <strong>To:</strong> {{ flight.destination }}</p>
        <p><strong>Price per seat:</strong> ${{ "%.2f"|format(flight.price) }}</p>
    </div>

    <div class="mt-8 flex flex-col md:flex-row gap-8">
        <!-- Seat Layout -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Aircraft Layout</h2>
            <div id="seat-map" class="seat-layout">
                <!-- Seats will be generated by JavaScript -->
            </div>
            <div class="mt-4 flex justify-around">
                <div class="flex items-center"><div class="seat available mr-2"></div> Available</div>
                <div class="flex items-center"><div class="seat selected mr-2"></div> Selected</div>
                <div class="flex items-center"><div class="seat booked mr-2"></div> Booked</div>
            </div>
        </div>

        <!-- Booking Summary -->
        <div class="bg-white p-6 rounded-lg shadow-md flex-grow">
            <h2 class="text-xl font-semibold">Summary</h2>
            <div id="summary" class="mt-4">
                <p>Selected Seats: <span id="selected-seats-list">None</span></p>
                <p class="mt-2 text-2xl font-bold">Total: $<span id="total-price">0.00</span></p>
            </div>
            <!-- Payment Method -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-2">Mode of Payment</h3>
                <div class="space-y-2">
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-100 cursor-pointer">
                        <input type="radio" name="payment" class="form-radio" checked>
                        <span class="ml-3">UPI / Net Banking</span>
                    </label>
                </div>
            </div>
            <div class="mt-6">
                <button id="proceed-btn" class="w-full bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 disabled:bg-gray-400" disabled>
                    Confirm Booking
                </button>
            </div>
            <div id="booking-message" class="hidden mt-4 text-center"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const seatMap = document.getElementById('seat-map');
        const selectedSeatsList = document.getElementById('selected-seats-list');
        const totalPriceEl = document.getElementById('total-price');
        const proceedBtn = document.getElementById('proceed-btn');
        const messageDiv = document.getElementById('booking-message');

        const pricePerSeat = parseFloat('{{ flight.price }}');
        const seatsData = {{ seats|tojson }};
        const selectedSeats = new Set();

        // Generate seats (assuming a 3-aisle-3 layout)
        seatsData.forEach((seat, index) => {
            const seatEl = document.createElement('div');
            seatEl.classList.add('seat');
            seatEl.dataset.seatNumber = seat.seat_number;
            seatEl.innerText = seat.seat_number;

            if (seat.is_booked) {
                seatEl.classList.add('booked');
            } else {
                seatEl.classList.add('available');
                seatEl.addEventListener('click', () => toggleSeatSelection(seatEl));
            }
            
            seatMap.appendChild(seatEl);

            // Add an aisle space after the 3rd column
            if ((index + 1) % 3 === 0 && (index + 1) % 6 !== 0) {
                 const aisle = document.createElement('div');
                 aisle.classList.add('aisle');
                 seatMap.appendChild(aisle);
            }
        });

        function toggleSeatSelection(seatEl) {
            const seatNumber = seatEl.dataset.seatNumber;
            if (selectedSeats.has(seatNumber)) {
                selectedSeats.delete(seatNumber);
                seatEl.classList.remove('selected');
                seatEl.classList.add('available'); // Add this line
            } else {
                selectedSeats.add(seatNumber);
                seatEl.classList.add('selected');
            }
            updateSummary();
        }

        function updateSummary() {
            const selectedSeatsArr = Array.from(selectedSeats);
            selectedSeatsList.innerText = selectedSeatsArr.length > 0 ? selectedSeatsArr.join(', ') : 'None';
            const total = selectedSeatsArr.length * pricePerSeat;
            totalPriceEl.innerText = total.toFixed(2);
            proceedBtn.disabled = total === 0;
        }

        // Event listener for the booking confirmation button
        proceedBtn.addEventListener('click', async () => {
            const bookingData = {
                service_id: "{{ flight.id }}",
                type: "flight",
                seats: Array.from(selectedSeats).join(','),
                date: "{{ travel_date or '' }}"
            };

            proceedBtn.disabled = true;
            proceedBtn.textContent = 'Processing...';

            const response = await fetch("{{ url_for('create_booking') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(bookingData)
            });
            const result = await response.json();

            if (response.ok) {
                messageDiv.className = 'text-green-600 font-semibold';
                messageDiv.textContent = `Booking successful! ID: ${result.booking_id}. Redirecting...`;
                setTimeout(() => window.location.href = "{{ url_for('dashboard') }}", 3000);
            } else {
                messageDiv.className = 'text-red-600 font-semibold';
                messageDiv.textContent = result.message || 'An error occurred.';
                proceedBtn.disabled = false;
                proceedBtn.textContent = 'Confirm Booking';
            }
            messageDiv.classList.remove('hidden');
        });
    });
</script>
{% endblock %}