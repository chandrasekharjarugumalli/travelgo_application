{% extends 'base.html' %}
{% block title %}Select Seats - {{ service.name }}{% endblock %}

{% block content %}
<style>
    .seat {
        width: 40px;
        height: 40px;
        border: 1px solid #ccc;
        margin: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
    }
    .seat.available { background-color: #a0e8a0; }
    .seat.booked { background-color: #f0a0a0; cursor: not-allowed; }
    .seat.selected { background-color: #a0a0f0; }
    .seat-layout {
        display: grid;
        grid-template-columns: repeat(5, auto); /* 2 seats, aisle, 2 seats */
        gap: 5px;
        max-width: 320px;
    }
    .seat-layout .aisle-gap {
        width: 20px; /* Aisle space */
    }
</style>

<div class="container mx-auto p-8">
    <h1 class="text-3xl font-bold">Select Your Seats</h1>
    <div class="mt-4 text-lg">
        <p><strong>Bus:</strong> {{ service.name }} ({{ service.bus_type }})</p>
        <p><strong>From:</strong> {{ service.from_city }}</p>
        <p><strong>To:</strong> {{ service.to_city }}</p>
        <p><strong>Price per seat:</strong> ${{ "%.2f"|format(service.price) }}</p>
    </div>

    <div class="mt-8 flex flex-col md:flex-row gap-8">
        <!-- Seat Layout -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Bus Layout</h2>
            <div id="seat-map" class="seat-layout">
                <!-- Seats will be generated by JavaScript -->
            </div>
            <div class="mt-4 flex justify-around">
                <div class="flex items-center"><div class="seat available mr-2"></div> Available</div>
                <div class="flex items-center"><div class="seat selected mr-2"></div> Selected</div>
                <div class="flex items-center"><div class="seat booked mr-2"></div> Booked</div>
            </div>
        </div>

        <!-- Booking Summary -->
        <div class="bg-white p-6 rounded-lg shadow-md flex-grow">
            <h2 class="text-xl font-semibold">Summary</h2>
            <div id="summary" class="mt-4">
                <p>Selected Seats: <span id="selected-seats-list">None</span></p>
                <p class="mt-2 text-2xl font-bold">Total: $<span id="total-price">0.00</span></p>
            </div>
            <!-- Payment Method -->
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-2">Mode of Payment</h3>
                <div class="space-y-2">
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-100 cursor-pointer">
                        <input type="radio" name="payment" class="form-radio" checked>
                        <span class="ml-3">UPI / Net Banking</span>
                    </label>
                </div>
            </div>
            <div class="mt-6">
                <button id="proceed-btn" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 disabled:bg-gray-400" disabled>
                    Confirm Booking
                </button>
            </div>
            <div id="booking-message" class="hidden mt-4 text-center"></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const seatMap = document.getElementById('seat-map');
        const selectedSeatsList = document.getElementById('selected-seats-list');
        const totalPriceEl = document.getElementById('total-price');
        const proceedBtn = document.getElementById('proceed-btn');
        const messageDiv = document.getElementById('booking-message');

        const pricePerSeat = parseFloat('{{ service.price }}');
        const seatsData = {{ seats|tojson }};
        const selectedSeats = new Set();

        // Generate seats
        seatsData.forEach((seat, index) => {
            const seatEl = document.createElement('div');
            seatEl.classList.add('seat');
            seatEl.dataset.seatNumber = seat.seat_number;
            seatEl.innerText = seat.seat_number;

            if (seat.is_booked) {
                seatEl.classList.add('booked');
            } else {
                seatEl.classList.add('available');
                seatEl.addEventListener('click', () => toggleSeatSelection(seatEl));
            }
            
            seatMap.appendChild(seatEl);

            // Add an aisle space after every 2nd seat to create a 2x2 layout
            if ((index + 1) % 2 === 0 && (index + 1) % 4 !== 0) {
                 const aisle = document.createElement('div');
                 aisle.classList.add('aisle-gap');
                 seatMap.appendChild(aisle);
            }
        });

        function toggleSeatSelection(seatEl) {
            const seatNumber = seatEl.dataset.seatNumber;
            if (selectedSeats.has(seatNumber)) {
                selectedSeats.delete(seatNumber);
                seatEl.classList.remove('selected');
                seatEl.classList.add('available'); // Make it green again
            } else {
                selectedSeats.add(seatNumber);
                seatEl.classList.add('selected');
                seatEl.classList.remove('available'); // Remove green when selected
            }
            updateSummary();
        }

        function updateSummary() {
            const selectedSeatsArr = Array.from(selectedSeats);
            selectedSeatsList.innerText = selectedSeatsArr.length > 0 ? selectedSeatsArr.join(', ') : 'None';
            totalPriceEl.innerText = (selectedSeatsArr.length * pricePerSeat).toFixed(2);

            if (selectedSeatsArr.length > 0) {
                proceedBtn.disabled = false;
            } else {
                proceedBtn.disabled = true;
            }
        }

        proceedBtn.addEventListener('click', async () => {
            const bookingData = {
                service_id: "{{ service.id }}",
                type: "bus",
                seats: Array.from(selectedSeats).join(','),
                date: "{{ travel_date }}"
            };

            proceedBtn.disabled = true;
            proceedBtn.textContent = 'Processing...';

            try {
                const response = await fetch("{{ url_for('create_booking') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });

                const result = await response.json();

                if (response.ok) {
                    messageDiv.className = 'text-green-600 font-semibold';
                    messageDiv.textContent = `Booking successful! Your Booking ID is ${result.booking_id}. Redirecting to dashboard...`;
                    setTimeout(() => {
                        window.location.href = "{{ url_for('dashboard') }}";
                    }, 3000);
                } else {
                    messageDiv.className = 'text-red-600 font-semibold';
                    messageDiv.textContent = result.message || 'An unknown error occurred.';
                    proceedBtn.disabled = false;
                    proceedBtn.textContent = 'Confirm Booking';
                }
                messageDiv.classList.remove('hidden');

            } catch (error) {
                messageDiv.className = 'text-red-600 font-semibold';
                messageDiv.textContent = 'A network error occurred. Please try again.';
                messageDiv.classList.remove('hidden');
                proceedBtn.disabled = false;
                proceedBtn.textContent = 'Confirm Booking';
                console.error('Booking fetch error:', error);
            }
        });

    });
</script>
{% endblock %}
